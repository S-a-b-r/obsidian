10.07.2024 23:55
Tags: #info

---
# defer
Defer - это оператор отложенного вызова. Используется, например, чтобы не забыть закрыть поток чтения файла.

```go
resource := System.Acquire("resourceID")
defer System.Close(resource)
```
Оператор `defer` используют внутри функции. Введем обозначения "Отложившая функция" - функция, внутри которой вызывается defer. "Отложенная" - функция, которую откладывает defer. 

Инструкция `defer` вычисляет аргументы для вызова, но вызов не делает. Вызов выполняется перед тем, как отложившая его функция вернет управление.

Работу оператора можно описать следующим образом.
1. Идёт обычное выполнение программы.
2. Наступает очередь выполнения оператора `defer`.
3. Вычисляются операнды отложенной функции, если такие есть.
4. Вызов функции вместе со значениями откладывается в специальный стек.
5. Выполнение функции продолжается. Если встречается оператор `defer`, то повторяем пункты 3 и 4.
6. Если встречается оператор `return`, то функция вычисляет его операнды и сохраняет значение в буфер.
7. Если стек отложенных вызовов не пустой, то извлекаем из него вызов функции и выполняем его.
8. Повторяем пункт 7, пока стек не опустеет.
9. Выходим из функции, возвращая значение из буфера.

Важно понимать, что результат функции вычисляется до выполнения отложенных вызовов.

Отложенных вызовов может быть несколько. Тогда они выполняются снизу вверх(т.к. лежат в стеке).

```go
fmt.Println("Hello")
for i := 1; i <= 3; i++ {
    defer fmt.Println(i)
}
fmt.Println("World")
```
Выведет 
```bash
Hello
World
3
2
1
```

---
### Zero-links:
[[00 Backend]] [[00 Golang]]

---
### Links: