23.08.2024 17:49
Tags: #info

---
# Внешние зависимости

Есть два способа загрузить внешние пакеты:
- Вручную утилитой `go get` [Дока](https://pkg.go.dev/cmd/go/internal/get)
- Через `go.mod`

## Установка пакетов вручную утилитой `go get`

В случае использования `go get` установка стороннего пакета выглядит так:

```
go get github.com/username/packagename 
```

Утилита `go get` сходит на `https://github.com/username/packagename` и скачает требуемый пакет, если он был найден по переданному URL. Если система контроля версий поддерживает несколько протоколов, Go по очереди попробует все. Например, в случае гита он попробует `https://` и `git+ssh://`.
После этого скачанные данные будут помещены в `GOPATH/src/username/packagename`.

## Установка зависимостей из `go.mod`

Система модулей позволяет явно прописать список зависимостей проекта. Для этого используется директива [require](https://golang.org/ref/mod#go-mod-file-require). После запуска кода Go автоматически скачает пакеты, перечисленные в блоке `require`, и закеширует их в директории `$GOPATH/pkg/mod`.

Например, если в модуле есть единственная зависимость от библиотеки `github.com/stretchr/testify`, то `go.mod` будет иметь вид:

```
module somemodule

go 1.16

require github.com/stretchr/testify v1.7.0 
```

Также будет создан специальный файл `go.sum`, обеспечивающий стопроцентную воспроизводимость запусков. Он содержит хеш-суммы всех модулей и тем самым гарантирует воспроизводимую установку модулей на разных окружениях. Подробнее можно прочитать [здесь](https://github.com/golang/go/wiki/Modules#is-gosum-a-lock-file-why-does-gosum-include-information-for-module-versions-i-am-no-longer-using).


---

Зачастую не нужно вручную прописывать зависимости в `go.mod`. Go может автоматически обновить список зависимостей в `go.mod` при запуске программы (имеется в виду вызов `go run`, `go build`, `go test`), если путь импорта библиотеки — это URL до репозитория с кодом и не требуется версия библиотеки, отличная от актуальной.

---
Если нужна не самая свежая версия библиотеки, можно указать в директиве require нужную версию, в примере выше - v1.7.0

## Подмена зависимостей

Иногда нужно подменить библиотеку в коде её форком (копией), но при этом не менять все пути импорта. Например, в ситуации, когда в библиотеке обнаружен критичный баг, и не известно, когда его исправят.

На помощь приходит директива [replace](https://golang.org/ref/mod#go-mod-file-replace). Эта директива также позволяет заменить один внешний модуль (или определённую его версию) на другой.
Это можно сделать так:

```
replace (
    golang.org/x/net v1.2.3 => example.com/fork/net v1.4.5
    golang.org/x/net => example.com/fork/net v1.4.5
) 
```

## Сохранение зависимостей

Что если код зависит от репозитория, который внезапно был удалён или стал приватным?

Если надо каждый раз ходить за ним в соответствующие репозитории систем контроля версий, это [проблема](https://qz.com/646467/how-one-programmer-broke-the-internet-by-deleting-a-tiny-piece-of-code/). Репозиторий может быть недоступен из-за блокировок, либо это может быть локальный репозиторий, к которому нужно подключаться через proxy, либо меинтейнер может просто удалить свой репозиторий по каким-то своим причинам.

Есть два решения: [[Вендоринг]] и [[go proxy]].

---
### Zero-links:
[[00 Backend]] [[00 Golang]]

---
### Links:
[[Вендоринг]] [[go proxy]]